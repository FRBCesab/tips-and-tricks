---
title: "Occupancy models in R"
author: "Lisa Nicvert"
date: "2026-01-06"
categories: [r, statistics, occupancy]
image: ""
toc: true
draft: false
lightbox: true
code-overflow: scroll
bibliography: references.bib
---

> Question. Why do we talk out loud when we know we're alone? Conjecture. Because we know we're not.
>
> -- *The Twelfth Doctor, Doctor Who (Series 8, Episode 4: "Listen")*


## Introduction

It's not because you didn't see something that this thing wasn't present. This is the concept behind occupancy models: our observations aren't a direct representation of reality, but merely of what we can detect.

Occupancy models were first published in 2002 [@mackenzie2002] in the context of species occurrence modelling. Many extensions of occupancy have been proposed since, allowing to take into account multiple species, explicitly model occupancy dynamics, or a continuous detection process. In this blog post, we will only go over the simple occupancy model described by @mackenzie2002.

## Simple occupancy model

The occupancy model is a hierarchical model, i.e. a model with two stages, to distinguish the real and the observed state.

The *true* presence or absence of a species in a given site $i = 1, 2, ..., M$ is noted $z_i$. The *observed* presence or absence, for a given visit $j$, is noted $y_{ij}$. Then, the occupancy model for a given site $i$ is written as:

$$
y_{ij} \sim Bern(z_i~p)
$$ 

- if the species is really present in site $i$ ($z_i = 1$), then it is detected with probability $p$ according to a Bernoulli trial. 
- if the species is absent in site $i$ ($z_i = 0$), then we assume that it cannot be detected (no false detection).

In the occupancy framework, $z_i$ itself is governed by a Bernoulli trial of probability $\psi$.

$$
z_i \sim Bern(\psi)
$$ 

$\psi$ is called the *occupancy probability*: most of the times, when dealing with occupancy, that's the quantity we're really interested in.

## Simulate occupancy

Occupancy models are really easy to simulate: here is a sample R code to simulate data under a simple occupancy model.

```{r}
set.seed(42)

M <- 100 # number of sites
p <- 0.2 # detection probability
psi <- 0.8 # occupancy

# Simulate a number of visits for each site
nvisit <- rpois(n = M, lambda = 3)
nvisit[nvisit == 0] <- 1 # Don't allow zero visits

# Initialize vectors
z <- vector(mode = "numeric", length = M)
y <- vector(mode = "list", length = M)

for (i in 1:M) { # for each site
  # Simulate true presence/absence at site i
  zi <- rbinom(n = 1, size = 1, prob = psi)
  
  # Simulate observed presence/absence at site i for all visits
  yij <- rbinom(n = nvisit[i], 
                size = 1, prob = p*zi)
  
  z[i] <- zi # True sites states
  y[[i]] <- yij # Detections
}
```

In this simulation, the true proportion of occupied sites is `r sum(z)/M`. It is very close to the occupancy parameter $\psi = `r psi`$ (but it is not _exactly_ equal because of the stochastic nature of our model).

```{r}
# True proportion of occupied sites
sum(z)/M
```

The proportion of sites that we *detect* as occupied (what is called the *naive occupancy*)  is `r sum(sapply(y, function(yi) any(yi != 0)))/M`, which wildly under-estimates $\psi$.

```{r}
# Proportion of sites with at least one detection
sum(sapply(y, function(yi) any(yi != 0)))/M
```

## Inferring occupancy models in R

Now the real interest of occupancy models is, of course, to analyse a dataset of species detections. Inferring parameters from data is possible, under three main conditions:

-   you have repeated visits. This is an crucial point which allows parameter identifiability.
-   the occupancy you measure is constant for all visits (closure assumption): therefore, the site must not change status across the study period[^1].
-   there are no false detections. The model automatically assumes that a detection event means that the site is really occupied. False detections might induce a positive bias in your estimates.

[^1]: In practice, this assumption is often violated in studies using occupancy models: this has been discussed extensively in the literature (see for example @valente2024), and authors have proposed to critically evaluate whether the closure assumption is met to interpret the inferred occupancy.

There are lots of strategies to infer occupancy models in R: among the most popular occupancy packages are `unmarked` and `spOccupancy`. Many people will also use bayesian softwares like `JAGS` (e.g. with the R package `jagsUI` or `rjags`), `nimble` or `stan`(R packages`cmdstanr`or`rstan`).

In this blogpost, we will focus on two of them: (1) `unmarked` and (2)`stan` (using the R interface package `cmdstanr`).

### unmarked

The R package `unmarked` is designed specifically for occupancy (and other models) inference in R, using maximum likelihood estimation (frequentist statistics).

First, we have to format the observed visits to an `unmarkedFrameOccu` object, as exemplified below:

```{r}
library(unmarked)

# Format the list of observed detections y
max_visit <- max(sapply(y, length)) # get maximum number of detections

# Transform y to matrix
y_matrix <- matrix(data = NA,
                   nrow = M,
                   ncol = max_visit)
for (i in 1:M) { # for each site
  nvisit_i <- length(y[[i]]) # get number of visits
  y_matrix[i, 1:nvisit_i] <- y[[i]] # fill n-th first rows with detection history
}

# Each row contains the detections at a site, filled with NAs for 
# sites that have less visits than the most visited one
head(y_matrix, 3)

# Cast y_matrix to unmarkedFrameOccu
y_occu <- unmarked::unmarkedFrameOccu(y_matrix)
head(y_occu, 3)
```

In unmarked, the main function to infer parameters of a simpler occupancy model is `occu`. In its simplest form, it only needs two arguments: 

- `formula`, which gives the formulas for the logit of $p$ and $\psi$. Here, since occupancy and detection are constant, we will set them to `~1 ~1`.
- `data`: an `unmarkedFrameOccu` object containing observed detections (here, `y_occu`).

```{r}
# Infer occupancy
occ <- unmarked::occu(formula = ~1 ~1, 
                      data = y_occu)

class(occ)
summary(occ)
```
The output of the model is an `unmarkedFitOccu` object. The summary gives us the parameter estimates on the logit scale (i.e. we get $\text{logit}(p)$ and $\text{logit}(\psi)$), but we can get estimates on the natural scale with `backTransform`:

```{r}
# Get detection (p) on the natural scale
unmarked::backTransform(occ, type = "det")

# Get occupancy (state parameter, psi) on the natural scale
unmarked::backTransform(occ, type = "state")
```
The agreement between true and inferred parameters is quite good (see figure below).

```{r}
#| code-fold: true
#| fig-width: 7
#| fig-height: 4

library(ggplot2)

p_inf <- unmarked::predict(occ, 
                           type = "det",
                           backTransform = TRUE,
                           newdata = data.frame(1))
psi_inf <- unmarked::predict(occ, 
                             type = "state",
                             backTransform = TRUE,
                             newdata = data.frame(1))

param_df <- data.frame(param = c("p", "p", "psi", "psi"),
                       type = c("inferred", "true", "inferred", "true"),
                       estimate = c(p_inf$Predicted, p,
                                    psi_inf$Predicted, psi),
                       min = c(p_inf$lower, NA,
                               psi_inf$lower, NA),
                       max = c(p_inf$upper, NA,
                               psi_inf$upper, NA))

ggplot(param_df) +
  geom_errorbar(data = subset(param_df, type == "inferred"),
                aes(xmin = min, xmax = max, y = param,
                    color = type)) +
  geom_point(aes(x = estimate, y = param,
                 color = type)) +
  theme_bw(base_size = 15) +
  theme(axis.title = element_blank())
```

