<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lisa Nicvert">
<meta name="dcterms.date" content="2026-01-06">

<title>Occupancy models in R – Tips and tricks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-5b411006c02ff6717a17d460af8e4cf1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-bebd73b9afcdb0801a0fe0190f1283cd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/favicon.png" alt="" class="navbar-logo light-content">
    <img src="../../images/favicon.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tips and tricks</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contribute.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/frbcesab/tips-and-tricks"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Occupancy models in R</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">r</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">occupancy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Lisa Nicvert </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 6, 2026</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#simple-occupancy-model" id="toc-simple-occupancy-model" class="nav-link" data-scroll-target="#simple-occupancy-model">Simple occupancy model</a></li>
  <li><a href="#simulate-occupancy" id="toc-simulate-occupancy" class="nav-link" data-scroll-target="#simulate-occupancy">Simulate occupancy</a></li>
  <li><a href="#infer-occupancy-models-in-r" id="toc-infer-occupancy-models-in-r" class="nav-link" data-scroll-target="#infer-occupancy-models-in-r">Infer occupancy models in R</a>
  <ul class="collapse">
  <li><a href="#unmarked" id="toc-unmarked" class="nav-link" data-scroll-target="#unmarked"><code>unmarked</code></a></li>
  <li><a href="#stan" id="toc-stan" class="nav-link" data-scroll-target="#stan">Stan</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#other-resources" id="toc-other-resources" class="nav-link" data-scroll-target="#other-resources">Other resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<blockquote class="blockquote">
<p>Question. Why do we talk out loud when we know we’re alone? Conjecture. Because we know we’re not.</p>
<p>– <em>The Twelfth Doctor, Doctor Who (Series 8, Episode 4: “Listen”)</em></p>
</blockquote>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>It’s not because we didn’t see something that this thing wasn’t present. At least, that’s the idea behind occupancy models: our observations aren’t a direct representation of reality, but merely of what we can detect.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="bird.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Present (z_i = 1), but not detected (y_{ij} = 0). Photo by Caroline Kirk (source)"><img src="bird.png" class="img-fluid figure-img" alt="Present (z_i = 1), but not detected (y_{ij} = 0). Photo by Caroline Kirk (source)"></a></p>
<figcaption>Present (<span class="math inline">\(z_i = 1\)</span>), but not detected (<span class="math inline">\(y_{ij} = 0\)</span>). <em>Photo by Caroline Kirk (<a href="https://www.independent.co.uk/news/uk/wildlife-photographer-owl-camera-image-b1818585.html">source</a>)</em></figcaption>
</figure>
</div>
<p>Occupancy models were first published by <span class="citation" data-cites="mackenzie2002">MacKenzie et al. (<a href="#ref-mackenzie2002" role="doc-biblioref">2002</a>)</span> in the context of species occurrence modelling. Many extensions of occupancy have been proposed since, allowing to explicitly model occupancy dynamics <span class="citation" data-cites="mackenzie_estimating_2003">(<a href="#ref-mackenzie_estimating_2003" role="doc-biblioref">MacKenzie et al. 2003</a>)</span>, take into account multiple species <span class="citation" data-cites="rota_multispecies_2016">(<a href="#ref-rota_multispecies_2016" role="doc-biblioref">Rota et al. 2016</a>)</span> or a continuous detection process <span class="citation" data-cites="mackenzie_estimating_2003">(<a href="#ref-mackenzie_estimating_2003" role="doc-biblioref">MacKenzie et al. 2003</a>)</span>. This blog post only goes over the original simple occupancy model.</p>
</section>
<section id="simple-occupancy-model" class="level2">
<h2 class="anchored" data-anchor-id="simple-occupancy-model">Simple occupancy model</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="diagram.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Summary diagram of the structure of an occupancy model."><img src="diagram.png" class="img-fluid figure-img" style="width:80.0%" alt="Summary diagram of the structure of an occupancy model."></a></p>
<figcaption>Summary diagram of the structure of an occupancy model.</figcaption>
</figure>
</div>
<p>To discriminate between the real and the observed states, occupancy models have one parameter for each of these states. The <em>true</em> presence or absence of a species in a given site <span class="math inline">\(i\)</span> is noted <span class="math inline">\(z_i\)</span>. The <em>observed</em> presence or absence at site <span class="math inline">\(i\)</span> for a given visit <span class="math inline">\(j\)</span> is noted <span class="math inline">\(y_{ij}\)</span>.</p>
<p>Then, the occupancy model for a given site <span class="math inline">\(i\)</span> is written as:</p>
<p><span class="math display">\[
y_{ij} \sim Bern(z_i~p)
\]</span></p>
<ul>
<li>if the species is really present in site <span class="math inline">\(i\)</span> (<span class="math inline">\(z_i = 1\)</span>), then it is detected (<span class="math inline">\(y_{ij} = 1\)</span>) with probability <span class="math inline">\(p\)</span> according to a Bernoulli trial.</li>
<li>if the species is absent in site <span class="math inline">\(i\)</span> (<span class="math inline">\(z_i = 0\)</span>), then we assume that it cannot be detected (<span class="math inline">\(y_{ij}\)</span> has to be zero) (no false detection).</li>
</ul>
<p>In the occupancy framework, <span class="math inline">\(z_i\)</span> itself is governed by a Bernoulli trial of probability <span class="math inline">\(\psi\)</span>.</p>
<p><span class="math display">\[
z_i \sim Bern(\psi)
\]</span></p>
<p><span class="math inline">\(\psi\)</span> is called the <em>occupancy probability</em>: most of the times, when dealing with occupancy, that’s the quantity we’re really interested in.</p>
</section>
<section id="simulate-occupancy" class="level2">
<h2 class="anchored" data-anchor-id="simulate-occupancy">Simulate occupancy</h2>
<p>Occupancy models are really easy to simulate: here is a sample R code to simulate data under a simple occupancy model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>M <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># Number of sites</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>p <span class="ot">&lt;-</span> <span class="fl">0.4</span> <span class="co"># Detection probability</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>psi <span class="ot">&lt;-</span> <span class="fl">0.8</span> <span class="co"># Occupancy</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># Simulate a number of visits for each site</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>nvisit <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> M, <span class="at">lambda =</span> <span class="dv">3</span>)</span>
<span id="cb1-9"><a href="#cb1-9"></a>nvisit[nvisit <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Don't allow zero visits</span></span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># Initialize vectors</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>z <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> M)</span>
<span id="cb1-13"><a href="#cb1-13"></a>y <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> M)</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M) { <span class="co"># For each site</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="co"># Simulate true presence/absence at site i</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  zi <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> psi)</span>
<span id="cb1-18"><a href="#cb1-18"></a>  </span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="co"># Simulate observed presence/absence at site i for all visits</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  yij <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> nvisit[i], </span>
<span id="cb1-21"><a href="#cb1-21"></a>                <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p<span class="sc">*</span>zi)</span>
<span id="cb1-22"><a href="#cb1-22"></a>  </span>
<span id="cb1-23"><a href="#cb1-23"></a>  z[i] <span class="ot">&lt;-</span> zi <span class="co"># True sites states</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>  y[[i]] <span class="ot">&lt;-</span> yij <span class="co"># Detections</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In this simulation, the true proportion of occupied sites is 0.73. It is very close to the occupancy parameter <span class="math inline">\(\psi = 0.8\)</span> (but it is not <em>exactly</em> equal because of the stochastic nature of our model).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># True proportion of occupied sites</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">sum</span>(z)<span class="sc">/</span>M</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.73</code></pre>
</div>
</div>
<p>The proportion of sites that we <em>detect</em> as occupied (what is called the <em>naive occupancy</em>) is 0.51, which wildly under-estimates <span class="math inline">\(\psi\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Proportion of sites with at least one detection</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">sum</span>(<span class="fu">sapply</span>(y, <span class="cf">function</span>(yi) <span class="fu">any</span>(yi <span class="sc">!=</span> <span class="dv">0</span>)))<span class="sc">/</span>M</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.51</code></pre>
</div>
</div>
</section>
<section id="infer-occupancy-models-in-r" class="level2">
<h2 class="anchored" data-anchor-id="infer-occupancy-models-in-r">Infer occupancy models in R</h2>
<p>Now, the true value of occupancy models lies in the analysis of species detections. Inferring parameters from data is possible under three main conditions:</p>
<ul>
<li>You have repeated visits. This is an crucial point which allows parameter identifiability.</li>
<li>The site remains in the same state (occupied or unoccupied) during the entire study period (closure assumption)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</li>
<li>There are no false detections. The model automatically assumes that a detection event means that the site is really occupied, and false detections might induce a positive bias in occupancy estimates.</li>
</ul>
<p>There are lots of strategies to infer occupancy models in R: among the most popular occupancy packages are <code>unmarked</code> and <code>spOccupancy</code>. Many people will also use Bayesian softwares like <code>JAGS</code> (e.g.&nbsp;with the R package <code>jagsUI</code> or <code>rjags</code>), <code>nimble</code> or Stan (with the R packages<code>cmdstanr</code>or<code>rstan</code>).</p>
<p>This blog post focuses on two of them: <code>unmarked</code> and Stan (using the R interface package <code>cmdstanr</code>).</p>
<section id="unmarked" class="level3">
<h3 class="anchored" data-anchor-id="unmarked"><code>unmarked</code></h3>
<p>The R package <a href="https://rbchan.github.io/unmarked/"><code>unmarked</code></a> has functions specifically designed for occupancy inference in R using maximum likelihood estimation (frequentist statistics).</p>
<p>First, we have to format the observed visits to an <code>unmarkedFrameOccu</code> object, as exemplified below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">library</span>(unmarked)</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co"># Format the list of observed detections y</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>max_visit <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">sapply</span>(y, length)) <span class="co"># Get maximum number of detections</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co"># Transform y to matrix</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>y_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>                   <span class="at">nrow =</span> M,</span>
<span id="cb6-9"><a href="#cb6-9"></a>                   <span class="at">ncol =</span> max_visit)</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M) { <span class="co"># For each site</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  nvisit_i <span class="ot">&lt;-</span> <span class="fu">length</span>(y[[i]]) <span class="co"># Get number of visits</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  y_matrix[i, <span class="dv">1</span><span class="sc">:</span>nvisit_i] <span class="ot">&lt;-</span> y[[i]] <span class="co"># Fill n-th first rows with detection history</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>}</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># Each row contains the detections at a site, filled with NAs for </span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co"># sites that have less visits than the most visited one</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="fu">head</span>(y_matrix, <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
[1,]    0    0    0    1    1   NA   NA   NA
[2,]    1    0    0    1    1    1   NA   NA
[3,]    0    0   NA   NA   NA   NA   NA   NA</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Cast y_matrix to unmarkedFrameOccu</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>y_occu <span class="ot">&lt;-</span> unmarked<span class="sc">::</span><span class="fu">unmarkedFrameOccu</span>(y_matrix)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">head</span>(y_occu, <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data frame representation of unmarkedFrame object.
  y.1 y.2 y.3 y.4 y.5 y.6 y.7 y.8
1   0   0   0   1   1  NA  NA  NA
2   1   0   0   1   1   1  NA  NA
3   0   0  NA  NA  NA  NA  NA  NA</code></pre>
</div>
</div>
<p>In <code>unmarked</code>, the main function to infer parameters of a simpler occupancy model is <code>occu</code>, which uses a maximum likelihood estimator. In its simplest form, it only needs two arguments:</p>
<ul>
<li><code>formula</code>, which gives the formulas for the logit of <span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span>. Here, since occupancy and detection are constant, we will set them to <code>~1 ~1</code>.</li>
<li><code>data</code>: an <code>unmarkedFrameOccu</code> object containing observed detections (here, <code>y_occu</code>).</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Infer occupancy</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>occ <span class="ot">&lt;-</span> unmarked<span class="sc">::</span><span class="fu">occu</span>(<span class="at">formula =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">~</span><span class="dv">1</span>, </span>
<span id="cb10-3"><a href="#cb10-3"></a>                      <span class="at">data =</span> y_occu)</span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="fu">class</span>(occ)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "unmarkedFitOccu"
attr(,"package")
[1] "unmarked"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">summary</span>(occ)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
unmarked::occu(formula = ~1 ~ 1, data = y_occu)

Occupancy (logit-scale):
 Estimate    SE    z P(&gt;|z|)
     1.03 0.406 2.54  0.0112

Detection (logit-scale):
 Estimate    SE     z  P(&gt;|z|)
   -0.623 0.184 -3.38 0.000722

AIC: 360.8983 
Number of sites: 100</code></pre>
</div>
</div>
<p>The output of the model is an <code>unmarkedFitOccu</code> object. The summary gives us the parameter estimates on the logit scale (i.e.&nbsp;we get <span class="math inline">\(\text{logit}(p)\)</span> and <span class="math inline">\(\text{logit}(\psi)\)</span>), but we can get estimates on the natural scale with <code>backTransform</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Get detection (p) on the natural scale</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>unmarked<span class="sc">::</span><span class="fu">backTransform</span>(occ, <span class="at">type =</span> <span class="st">"det"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Backtransformed linear combination(s) of Detection estimate(s)

 Estimate     SE LinComb (Intercept)
    0.349 0.0419  -0.623           1

Transformation: logistic </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Get occupancy (state parameter, psi) on the natural scale</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>unmarked<span class="sc">::</span><span class="fu">backTransform</span>(occ, <span class="at">type =</span> <span class="st">"state"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Backtransformed linear combination(s) of Occupancy estimate(s)

 Estimate     SE LinComb (Intercept)
    0.737 0.0788    1.03           1

Transformation: logistic </code></pre>
</div>
</div>
<p>And inferred parameters are a good approximation of true values (see figure below).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a>p_inf <span class="ot">&lt;-</span> unmarked<span class="sc">::</span><span class="fu">predict</span>(occ, </span>
<span id="cb18-4"><a href="#cb18-4"></a>                           <span class="at">type =</span> <span class="st">"det"</span>,</span>
<span id="cb18-5"><a href="#cb18-5"></a>                           <span class="at">backTransform =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-6"><a href="#cb18-6"></a>                           <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="dv">1</span>))</span>
<span id="cb18-7"><a href="#cb18-7"></a>psi_inf <span class="ot">&lt;-</span> unmarked<span class="sc">::</span><span class="fu">predict</span>(occ, </span>
<span id="cb18-8"><a href="#cb18-8"></a>                             <span class="at">type =</span> <span class="st">"state"</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>                             <span class="at">backTransform =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-10"><a href="#cb18-10"></a>                             <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="dv">1</span>))</span>
<span id="cb18-11"><a href="#cb18-11"></a></span>
<span id="cb18-12"><a href="#cb18-12"></a>umk_param_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">param =</span> <span class="fu">c</span>(<span class="st">"p"</span>, <span class="st">"p"</span>, <span class="st">"psi"</span>, <span class="st">"psi"</span>),</span>
<span id="cb18-13"><a href="#cb18-13"></a>                           <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"inferred"</span>, <span class="st">"true"</span>, <span class="st">"inferred"</span>, <span class="st">"true"</span>),</span>
<span id="cb18-14"><a href="#cb18-14"></a>                           <span class="at">estimate =</span> <span class="fu">c</span>(p_inf<span class="sc">$</span>Predicted, p,</span>
<span id="cb18-15"><a href="#cb18-15"></a>                                        psi_inf<span class="sc">$</span>Predicted, psi),</span>
<span id="cb18-16"><a href="#cb18-16"></a>                           <span class="at">min =</span> <span class="fu">c</span>(p_inf<span class="sc">$</span>lower, <span class="cn">NA</span>,</span>
<span id="cb18-17"><a href="#cb18-17"></a>                                   psi_inf<span class="sc">$</span>lower, <span class="cn">NA</span>),</span>
<span id="cb18-18"><a href="#cb18-18"></a>                           <span class="at">max =</span> <span class="fu">c</span>(p_inf<span class="sc">$</span>upper, <span class="cn">NA</span>,</span>
<span id="cb18-19"><a href="#cb18-19"></a>                                   psi_inf<span class="sc">$</span>upper, <span class="cn">NA</span>))</span>
<span id="cb18-20"><a href="#cb18-20"></a></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="fu">ggplot</span>(umk_param_df) <span class="sc">+</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> <span class="fu">subset</span>(umk_param_df, type <span class="sc">==</span> <span class="st">"inferred"</span>),</span>
<span id="cb18-23"><a href="#cb18-23"></a>                <span class="fu">aes</span>(<span class="at">xmin =</span> min, <span class="at">xmax =</span> max, <span class="at">y =</span> param,</span>
<span id="cb18-24"><a href="#cb18-24"></a>                    <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> param,</span>
<span id="cb18-26"><a href="#cb18-26"></a>                 <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30"></a>  <span class="fu">ggtitle</span>(<span class="st">"True and inferred occupancy parameters with unmarked"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-7-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="stan" class="level3">
<h3 class="anchored" data-anchor-id="stan">Stan</h3>
<p>Bayesian frameworks are also quite common to infer occupancy models, notably because they allow for more flexibility in the parameters specifications. Here, we use <a href="https://mc-stan.org/">Stan</a> through the R package <a href="https://mc-stan.org/cmdstanr/"><code>cmdstanr</code></a>. Stan is a Bayesian software using optimized algorithms for the MCMC samplers.</p>
<p>In Stan, it is more efficient to use a Binomial model specification: we model the <em>number of detections</em> <span class="math inline">\(n_i\)</span> at each site:</p>
<p><span class="math display">\[n_i \sim Binom({n_{\text{visit}}}_i, z_i~p) \quad \text{and} \quad z_i \sim Bern(\psi)\]</span> where <span class="math inline">\({n_{\text{visit}}}_i\)</span> the number of visits at site <span class="math inline">\(i\)</span>. The equations above are strictly equivalent to the general occupancy model specification described earlier.</p>
<p>The first step is to format our data to be used by Stan. For that, we aggregate our visits to total number of detections, and save data parameters to a list named <code>dat</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Format data for Stan</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>n <span class="ot">&lt;-</span> <span class="fu">sapply</span>(y, sum) <span class="co"># Number of detections</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>nvisit <span class="ot">&lt;-</span> <span class="fu">sapply</span>(y, length) <span class="co"># Number of visits</span></span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co"># List of parameters for Stan</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>dat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">M =</span> M,</span>
<span id="cb19-7"><a href="#cb19-7"></a>            <span class="at">n =</span> n,</span>
<span id="cb19-8"><a href="#cb19-8"></a>            <span class="at">nvisit =</span> nvisit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="stan-code" class="level4">
<h4 class="anchored" data-anchor-id="stan-code">Stan code</h4>
<p>Then, we write the Stan code to infer our occupancy parameters. Stan is a programming language in its own right, and here we will only go over the Stan syntax quickly.</p>
<p>Stan programs are organized in code blocks, which are indicated by opening and closing brackets as shown below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">data</span> {</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="co">// Code block to define data variables</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>}</span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="kw">parameters</span> {</span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="co">// Code block to define parameters</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>}</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">model</span> {</span>
<span id="cb20-10"><a href="#cb20-10"></a>  <span class="co">// Code block to infer parameters</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note that Stan comments are specified with a double backslash <code>//</code>. There are other optional code blocks (in fact, we will use one later), but the mandatory ones are shown above.</p>
<p>Let’s start by defining variables in the data block. Stan variables are typed (i.e.&nbsp;we must define their type manually with the statements before variables names). Here, we only need the 3 variables that we specified on our data list above.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">data</span> {</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M; <span class="co">// Number of sites</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="dt">array</span>[M] <span class="dt">int</span> nvisit; <span class="co">// Number of visits per sites-years</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="dt">array</span>[M] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n; <span class="co">// Observations vector</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Next, we define the parameters we want to infer in the parameters block. Here, they are defined on the logit scale because inferring unbounded parameters is more efficient in Stan.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">parameters</span> {</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="dt">real</span> psi_logit; <span class="co">// Value of psi on the logit scale</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="dt">real</span> p_logit; <span class="co">// Value of p on the logit scale</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The syntax of the model block is slightly more complex. There are 3 steps:</p>
<ul>
<li>Define the parameters priors: here, we use flat normal priors centered on zero with a standard deviation of 3. This amounts to initializing the log-posterior with a log-transformed normal density, which is what <code>target += normal_lpdf(param | 0, 3)</code> does.</li>
<li>(Optional) Define intermediate variables. Here, we define <code>nvi</code> as a shortcut for the number of visits for site <span class="math inline">\(i\)</span>.</li>
<li>Specify the model. This is where it requires a bit of work, because Stan cannot model discrete variables, so we have to update the posterior probability density manually instead. Fortunately, it is fairly easy to write with respect to <span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span>. Here, we won’t go into the details of these computations (but see <a href="#nte-posterior" class="quarto-xref">Note&nbsp;1</a> below).</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">model</span> {</span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="co">// 1. Priors</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="kw">target +=</span> normal_lpdf(psi_logit | <span class="dv">0</span>, <span class="dv">3</span>);</span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="kw">target +=</span> normal_lpdf(p_logit | <span class="dv">0</span>, <span class="dv">3</span>);</span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="co">// 2. Variables</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="dt">int</span> nvi;</span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="co">// 3. Model specification</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:M) { <span class="co">// Iterate over sites</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>    nvi = nvisit[i]; <span class="co">// Number of visits</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>    <span class="cf">if</span> (n[i] &gt; <span class="dv">0</span>) { <span class="co">// The species was seen</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>      <span class="co">// Update log-likelihood: species was detected | present</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>      <span class="kw">target +=</span> log_inv_logit(psi_logit) + </span>
<span id="cb23-15"><a href="#cb23-15"></a>        binomial_logit_lpmf(n[i] | nvi, p_logit);</span>
<span id="cb23-16"><a href="#cb23-16"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-17"><a href="#cb23-17"></a>      <span class="co">// Update log-likelihood: species was non-detected | present</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>      <span class="co">// or non-detected | absent</span></span>
<span id="cb23-19"><a href="#cb23-19"></a>      <span class="kw">target +=</span> log_sum_exp(log_inv_logit(psi_logit) + binomial_logit_lpmf(<span class="dv">0</span> | nvi, p_logit), </span>
<span id="cb23-20"><a href="#cb23-20"></a>        log1m_inv_logit(psi_logit));</span>
<span id="cb23-21"><a href="#cb23-21"></a>    }</span>
<span id="cb23-22"><a href="#cb23-22"></a>  }</span>
<span id="cb23-23"><a href="#cb23-23"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="nte-posterior" class="callout callout-style-default callout-note callout-titled" title="Log-posterior probability density computation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;1: Log-posterior probability density computation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Below, we give a bit more explanations about the computation of the log-posterior.</p>
<p>We distinguish between two cases to write the log-posterior:</p>
<ul>
<li><p>The species was detected at least once (case <code>n[i] &gt; 0</code>). In that case, we know that it was present (no false detections), so the conditional log-probability that the species was seen <span class="math inline">\(n_i\)</span> times (which is what we update <code>target</code> with) is the product of the occupancy probability <span class="math inline">\(\psi\)</span> and the binomial density probability of <span class="math inline">\(N = n\)</span>: <span class="math display">\[P(N = n_i | \{p, \psi\}) = \psi ~ \underbrace{\binom{{n_{\text{visit}}}_i}{n_i} p^{n_i} p^{{n_{\text{visit}}}_i - n_i}}_{\text{Binomial density probability}}\]</span> In Stan, parameters are on the logit scale: <code>psi_logit</code> is first back-transformed with <code>log_inv_logit</code> and Stan uses the Binomial density probability on the logit scale with <code>binomial_logit_lpmf</code>. Finally, because we compute the log-posterior, by properties of the logarithm the multiplication is changed to an addition.</p></li>
<li><p>When the species was not seen (<code>else</code> block), we have two options. Either the species was present, but undetected; or it was absent. In that case, the conditional log-probability is the sum of these two events: <span class="math display">\[P(N = 0 | \{p, \psi\}) = \underbrace{\psi ~ \binom{{n_{\text{visit}}}_i}{0} p^{0} p^{{n_{\text{visit}}}_i - 0}}_{\text{present, undetected}} + \underbrace{(1 - \psi)}_{\text{absent}}\]</span> In Stan, <code>log_sum_exp</code> is an efficient way to compute a logarithm of the sum above, and <code>log1m_inv_logit(psi_logit)</code> returns <span class="math inline">\(1 - \psi\)</span>.</p></li>
</ul>
<p>More details on log-likelihood computation can be found in <a href="https://htmlpreview.github.io/?https://github.com/bbennie/StanOccupancyModelTutorials/blob/master/OccupancyStanIntroduction.html">this blog post</a> or in chapter 2.4.6 of <span class="citation" data-cites="kery_applied_2016">Kéry and Royle (<a href="#ref-kery_applied_2016" role="doc-biblioref">2016</a>)</span>.</p>
</div>
</div>
<p>The final (and optional) code block we use here is a generated quantities block. It allows to compute <span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span> on the natural scale by using <code>inv_logit</code> to back-transform parameters.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; p = inv_logit(p_logit);</span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; psi = inv_logit(psi_logit);</span>
<span id="cb24-4"><a href="#cb24-4"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The final Stan code is summarised below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">data</span> {</span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M; <span class="co">// Number of sites</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="dt">array</span>[M] <span class="dt">int</span> nvisit; <span class="co">// Number of visits per sites-years</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="dt">array</span>[M] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n; <span class="co">// Observations vector</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>}</span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw">parameters</span> {</span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="dt">real</span> psi_logit; <span class="co">// Value of psi on the logit scale</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="dt">real</span> p_logit; <span class="co">// Value of p on the logit scale</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>}</span>
<span id="cb25-11"><a href="#cb25-11"></a></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="kw">model</span> {</span>
<span id="cb25-13"><a href="#cb25-13"></a>  <span class="co">// 1. Priors</span></span>
<span id="cb25-14"><a href="#cb25-14"></a>  <span class="kw">target +=</span> normal_lpdf(psi_logit | <span class="dv">0</span>, <span class="dv">3</span>);</span>
<span id="cb25-15"><a href="#cb25-15"></a>  <span class="kw">target +=</span> normal_lpdf(p_logit | <span class="dv">0</span>, <span class="dv">3</span>);</span>
<span id="cb25-16"><a href="#cb25-16"></a></span>
<span id="cb25-17"><a href="#cb25-17"></a>  <span class="co">// 2. Variables</span></span>
<span id="cb25-18"><a href="#cb25-18"></a>  <span class="dt">int</span> nvi;</span>
<span id="cb25-19"><a href="#cb25-19"></a></span>
<span id="cb25-20"><a href="#cb25-20"></a>  <span class="co">// 3. Model specification</span></span>
<span id="cb25-21"><a href="#cb25-21"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:M) { <span class="co">// Iterate over sites</span></span>
<span id="cb25-22"><a href="#cb25-22"></a>    nvi = nvisit[i]; <span class="co">// Number of visits</span></span>
<span id="cb25-23"><a href="#cb25-23"></a>    <span class="cf">if</span> (n[i] &gt; <span class="dv">0</span>) { <span class="co">// The species was seen</span></span>
<span id="cb25-24"><a href="#cb25-24"></a>      <span class="co">// Update log-likelihood: species was detected | present</span></span>
<span id="cb25-25"><a href="#cb25-25"></a>      <span class="kw">target +=</span> log_inv_logit(psi_logit) + binomial_logit_lpmf(n[i] | nvi, p_logit);</span>
<span id="cb25-26"><a href="#cb25-26"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-27"><a href="#cb25-27"></a>      <span class="co">// Update log-likelihood: species was non-detected | present</span></span>
<span id="cb25-28"><a href="#cb25-28"></a>      <span class="co">// or non-detected | absent</span></span>
<span id="cb25-29"><a href="#cb25-29"></a>      <span class="kw">target +=</span> log_sum_exp(log_inv_logit(psi_logit) + binomial_logit_lpmf(<span class="dv">0</span> | nvi, p_logit), log1m_inv_logit(psi_logit));</span>
<span id="cb25-30"><a href="#cb25-30"></a>    }</span>
<span id="cb25-31"><a href="#cb25-31"></a>  }</span>
<span id="cb25-32"><a href="#cb25-32"></a>}</span>
<span id="cb25-33"><a href="#cb25-33"></a></span>
<span id="cb25-34"><a href="#cb25-34"></a><span class="kw">generated quantities</span> {</span>
<span id="cb25-35"><a href="#cb25-35"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt; p = inv_logit(p_logit);</span>
<span id="cb25-36"><a href="#cb25-36"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; psi = inv_logit(psi_logit);</span>
<span id="cb25-37"><a href="#cb25-37"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="inference-with-cmdstanr" class="level4">
<h4 class="anchored" data-anchor-id="inference-with-cmdstanr">Inference with <code>cmdstanr</code></h4>
<p>Now, we can use this code to infer our occupancy parameters from R. The first step is to compile the Stan model using <code>cmdstan_model</code>, as shown in the code below. Here, we assume the Stan code above is written in a file, which path is stored in the <code>stan_file</code> variable in R.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a>model <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> stan_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can finally perform the inference on our <code>model</code> object, with the <code>$sample</code> method from the <code>CmdStanModel</code> class. The <code>$sample</code> method can be customised with many arguments, but here we only use our data list (<code>data</code>), the number of burn-in iterations (<code>warmup</code>), the number of post-burn-in iterations (<code>iter_sampling</code>) and the number of chains and their parallelisation (<code>chains</code> and <code>parallel_chains</code>).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>stanfit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat,</span>
<span id="cb27-2"><a href="#cb27-2"></a>                        <span class="at">iter_warmup =</span> <span class="dv">200</span>,</span>
<span id="cb27-3"><a href="#cb27-3"></a>                        <span class="at">iter_sampling =</span> <span class="dv">500</span>,</span>
<span id="cb27-4"><a href="#cb27-4"></a>                        <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb27-5"><a href="#cb27-5"></a>                        <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can inspect the inferred values with the <code>$summary</code> method.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>(stan_inf <span class="ot">&lt;-</span> stanfit<span class="sc">$</span><span class="fu">summary</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 10
  variable      mean   median     sd    mad       q5      q95  rhat ess_bulk
  &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 lp__      -115.    -114.    1.02   0.801  -117.    -114.     1.01     882.
2 psi_logit    1.18     1.11  0.484  0.440     0.491    2.06   1.00    1011.
3 p_logit     -0.651   -0.649 0.190  0.183    -0.970   -0.332  1.00     771.
4 p            0.344    0.343 0.0427 0.0409    0.275    0.418  1.00     771.
5 psi          0.754    0.753 0.0795 0.0808    0.620    0.887  1.00    1011.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The summary gives information about the log-posterior (<code>lp__</code>) and all inferred parameters (on the logit and the natural scales). For each parameter, a set of summary statistics which summarize their distribution are given. Three diagnostic parameters to evaluate MCMC sampling are also given (a convergence statistic <span class="math inline">\(\hat{R}\)</span>, and effective sample sizes (ESS)).</p>
<p>Finally, a graphical summary shows that inferred parameters are close to the real ones:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a>stan_param_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">param =</span> <span class="fu">c</span>(<span class="st">"p"</span>, <span class="st">"p"</span>, <span class="st">"psi"</span>, <span class="st">"psi"</span>),</span>
<span id="cb30-4"><a href="#cb30-4"></a>                            <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"inferred"</span>, <span class="st">"true"</span>, <span class="st">"inferred"</span>, <span class="st">"true"</span>),</span>
<span id="cb30-5"><a href="#cb30-5"></a>                            <span class="at">estimate =</span> <span class="fu">c</span>(stan_inf<span class="sc">$</span>mean[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"p"</span>], p,</span>
<span id="cb30-6"><a href="#cb30-6"></a>                                         stan_inf<span class="sc">$</span>mean[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"psi"</span>], psi),</span>
<span id="cb30-7"><a href="#cb30-7"></a>                            <span class="at">min =</span> <span class="fu">c</span>(stan_inf<span class="sc">$</span>q5[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"p"</span>], <span class="cn">NA</span>,</span>
<span id="cb30-8"><a href="#cb30-8"></a>                                    stan_inf<span class="sc">$</span>q5[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"psi"</span>], <span class="cn">NA</span>),</span>
<span id="cb30-9"><a href="#cb30-9"></a>                            <span class="at">max =</span> <span class="fu">c</span>(stan_inf<span class="sc">$</span>q95[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"p"</span>], <span class="cn">NA</span>,</span>
<span id="cb30-10"><a href="#cb30-10"></a>                                    stan_inf<span class="sc">$</span>q95[stan_inf<span class="sc">$</span>variable <span class="sc">==</span> <span class="st">"psi"</span>], <span class="cn">NA</span>))</span>
<span id="cb30-11"><a href="#cb30-11"></a></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="fu">ggplot</span>(stan_param_df) <span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> <span class="fu">subset</span>(stan_param_df, type <span class="sc">==</span> <span class="st">"inferred"</span>),</span>
<span id="cb30-14"><a href="#cb30-14"></a>                <span class="fu">aes</span>(<span class="at">xmin =</span> min, <span class="at">xmax =</span> max, <span class="at">y =</span> param,</span>
<span id="cb30-15"><a href="#cb30-15"></a>                    <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> param,</span>
<span id="cb30-17"><a href="#cb30-17"></a>                 <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb30-18"><a href="#cb30-18"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb30-19"><a href="#cb30-19"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-20"><a href="#cb30-20"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb30-21"><a href="#cb30-21"></a>  <span class="fu">ggtitle</span>(<span class="st">"True and inferred occupancy parameters with Stan"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this blog post, we have seen how the simple occupancy model is written and how simulate data under an occupancy model in R. We have then inferred occupancy models with the <code>unmarked</code> and <code>cmdstanr</code> R packages.</p>
<p>There is much more one can do with occupancy models. In particular, the parameters <span class="math inline">\(p\)</span> and <span class="math inline">\(\psi\)</span> are often not constant, and can be modeled as functions of covariates with a logit link, such as <span class="math inline">\(\text{logit}(\psi_i) = \beta_0 + \beta_1 x_i\)</span> or <span class="math inline">\(\text{logit}(p_{ij}) = \beta_0 + \beta_1 x_{ij}\)</span>. But this is a story for another blog post…</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-kery_applied_2016" class="csl-entry" role="listitem">
Kéry, Marc, and J. Andrew Royle. 2016. <em>Applied Hierarchical Modeling in Ecology: Analysis of Distribution, Abundance and Species Richness in <span>R</span> and <span>BUGS</span></em>. Amsterdam; Boston: Elsevier/<span>AP</span>, Academic Press is an imprint of Elsevier.
</div>
<div id="ref-mackenzie_estimating_2003" class="csl-entry" role="listitem">
MacKenzie, Darryl I., James D. Nichols, James E. Hines, Melinda G. Knutson, and Alan B. Franklin. 2003. <span>“Estimating Site Occupancy, Colonization, and Local Extinction When a Species Is Detected Imperfectly.”</span> <em>Ecology</em> 84 (8): 2200–2207. <a href="https://doi.org/10.1890/02-3090">https://doi.org/10.1890/02-3090</a>.
</div>
<div id="ref-mackenzie2002" class="csl-entry" role="listitem">
MacKenzie, Darryl I., James D. Nichols, Gideon B. Lachman, Sam Droege, J. Andrew Royle, and Catherine A. Langtimm. 2002. <span>“Estimating Site Occupancy Rates When Detection Probabilities Are Less Than One.”</span> <em>Ecology</em> 83 (8): 2248–55. <a href="https://doi.org/10.1890/0012-9658(2002)083[2248:ESORWD]2.0.CO;2">https://doi.org/10.1890/0012-9658(2002)083[2248:ESORWD]2.0.CO;2</a>.
</div>
<div id="ref-rota_multispecies_2016" class="csl-entry" role="listitem">
Rota, Christopher T., Marco A. R. Ferreira, Roland W. Kays, Tavis D. Forrester, Elizabeth L. Kalies, William J. McShea, Arielle W. Parsons, and Joshua J. Millspaugh. 2016. <span>“A Multispecies Occupancy Model for Two or More Interacting Species.”</span> <em>Methods in Ecology and Evolution</em> 7 (10): 1164–73. <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/2041-210X.12587">https://onlinelibrary.wiley.com/doi/abs/10.1111/2041-210X.12587</a>.
</div>
<div id="ref-valente2024" class="csl-entry" role="listitem">
Valente, Jonathon J., Vitek Jirinec, and Matthias Leu. 2024. <span>“Thinking Beyond the Closure Assumption: Designing Surveys for Estimating Biological Truth with Occupancy Models.”</span> <em>Methods in Ecology and Evolution</em> 15 (12): 2289–2300. <a href="https://doi.org/10.1111/2041-210X.14439">https://doi.org/10.1111/2041-210X.14439</a>.
</div>
</div>
</section>
<section id="other-resources" class="level2">
<h2 class="anchored" data-anchor-id="other-resources">Other resources</h2>
<ul>
<li>Richard A. Erickson’s <a href="https://github.com/bbennie/StanOccupancyModelTutorials">GitHub repository</a> with Stan occupancy models tutorials</li>
<li>Olivier Gimenez’s <a href="https://oliviergimenez.github.io/occupancy-workshop/">workshop</a> with resources on occupancy modelling with <code>unmarked</code></li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In practice, this assumption is often violated in studies using occupancy models: this has been discussed extensively in the literature (see for example <span class="citation" data-cites="valente2024">Valente, Jirinec, and Leu (<a href="#ref-valente2024" role="doc-biblioref">2024</a>)</span>), and authors have proposed to critically evaluate whether the closure assumption is met to interpret the inferred occupancy.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/frbcesab\.github\.io\/tips-and-tricks");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="frbcesab/tips-and-tricks" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© CC-By <a href="https://www.fondationbiodiversite.fr/en/about-the-foundation/le-cesab/">FRB-CESAB</a></p>
</div>   
    <div class="nav-footer-center">
<p>Code source available on <a href="https://github.com/frbcesab/tips-and-tricks/"><i class="fa-brands fa-github" aria-label="github"></i></a></p>
</div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>